{% extends "base.html" %}

{% block title %}Settings - YouTube Uploader{% endblock %}

{% block content %}
<div class="header">
    <h1>Settings</h1>
    <p>Configure your YouTube uploader preferences</p>
</div>

<div class="card">
    <h2>YouTube Account</h2>
    <div id="youtube-status">
        {% if config.youtube_credentials %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> YouTube account connected
            </div>
            <button type="button" class="btn btn-danger" onclick="disconnectYoutube()">
                <i class="fab fa-youtube"></i> Disconnect Account
            </button>
        {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> No YouTube account connected
            </div>
            <button type="button" class="btn btn-primary" onclick="connectYoutube()">
                <i class="fab fa-youtube"></i> Connect YouTube Account
            </button>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>Folder Settings</h2>
    <form id="settings-form">
        <div class="form-group">
            <label for="upload-folder">Default Upload Folder:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="upload-folder" name="upload_folder" 
                       value="{{ config.upload_folder or '' }}" placeholder="/path/to/videos" style="flex: 1;">
                <button type="button" class="btn btn-secondary" onclick="browseFolder('upload')">Browse</button>
            </div>
            <small style="color: #ccc;">Folder containing videos to upload</small>
        </div>
        
        <div class="form-group">
            <label for="log-folder">Log Folder:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="log-folder" name="log_folder" 
                       value="{{ config.log_folder or '' }}" placeholder="/path/to/logs" style="flex: 1;">
                <button type="button" class="btn btn-secondary" onclick="browseFolder('log')">Browse</button>
            </div>
            <small style="color: #ccc;">Folder where upload reports and logs will be saved</small>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Settings
        </button>
    </form>
</div>

<div class="card">
    <h2>Upload Preferences</h2>
    <form id="upload-preferences-form">
        <div class="form-group">
            <label for="default-privacy">Default Privacy Setting:</label>
            <select id="default-privacy" name="default_privacy">
                <option value="public" {{ 'selected' if config.upload_preferences.default_privacy == 'public' else '' }}>Public</option>
                <option value="unlisted" {{ 'selected' if config.upload_preferences.default_privacy == 'unlisted' else '' }}>Unlisted</option>
                <option value="private" {{ 'selected' if config.upload_preferences.default_privacy == 'private' else '' }}>Private</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="default-tags">Default Tags (comma-separated):</label>
            <input type="text" id="default-tags" name="default_tags" 
                   value="{{ config.upload_preferences.default_tags or 'shorts, upload, automated' }}"
                   placeholder="shorts, viral, trending">
        </div>
        
        <div class="form-group">
            <label for="upload-delay">Delay Between Uploads (seconds):</label>
            <input type="number" id="upload-delay" name="upload_delay" 
                   value="{{ config.upload_preferences.upload_delay or 10 }}"
                   min="1" max="300">
            <small style="color: #ccc;">Delay between each video upload to avoid rate limits</small>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Preferences
        </button>
    </form>
</div>

<div class="card">
    <h2>System Status</h2>
    <div id="system-status">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div style="background: #404040; padding: 10px; border-radius: 4px;">
                <strong>Google API:</strong> <span id="api-status">Checking...</span>
            </div>
            <div style="background: #404040; padding: 10px; border-radius: 4px;">
                <strong>Client Secrets:</strong> <span id="secrets-status">Checking...</span>
            </div>
        </div>
    </div>
</div>

<script>
    function browseFolder(type) {
        const currentValue = document.getElementById(type + '-folder').value;
        const newPath = prompt(`Enter ${type} folder path:`, currentValue);
        
        if (newPath && newPath.trim()) {
            document.getElementById(type + '-folder').value = newPath.trim();
        }
    }
    
    function connectYoutube() {
        // Open OAuth flow in new window
        const authWindow = window.open('/api/oauth_start', 'oauth', 
            'width=500,height=600,scrollbars=yes,resizable=yes');
        
        // Poll for completion
        const checkInterval = setInterval(() => {
            fetch('/api/oauth_status')
                .then(response => response.json())
                .then(data => {
                    if (data.completed) {
                        clearInterval(checkInterval);
                        if (authWindow) {
                            authWindow.close();
                        }
                        if (data.success) {
                            showAlert('YouTube account connected successfully!', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showAlert('YouTube authentication failed', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking OAuth status:', error);
                });
        }, 2000);
        
        // Stop polling after 5 minutes
        setTimeout(() => {
            clearInterval(checkInterval);
        }, 300000);
    }
    
    function disconnectYoutube() {
        if (confirm('Are you sure you want to disconnect your YouTube account?')) {
            fetch('/api/disconnect_youtube', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('YouTube account disconnected', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert('Error disconnecting account', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error disconnecting account', 'error');
                });
        }
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '1000';
        alertDiv.style.minWidth = '300px';
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 4000);
    }
    
    // Form submissions
    document.getElementById('settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/api/save_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings saved successfully!', 'success');
            } else {
                showAlert('Error saving settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error saving settings', 'error');
        });
    });
    
    document.getElementById('upload-preferences-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/api/save_preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Preferences saved successfully!', 'success');
            } else {
                showAlert('Error saving preferences', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error saving preferences', 'error');
        });
    });
    
    // Check system status on load
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/health')
            .then(response => response.json())
            .then(data => {
                document.getElementById('api-status').textContent = 
                    data.google_api_available ? '✓ Available' : '✗ Not Available';
                document.getElementById('api-status').style.color = 
                    data.google_api_available ? '#4CAF50' : '#f44336';
                    
                document.getElementById('secrets-status').textContent = 
                    data.client_secrets_exists ? '✓ Found' : '✗ Missing';
                document.getElementById('secrets-status').style.color = 
                    data.client_secrets_exists ? '#4CAF50' : '#f44336';
            })
            .catch(error => {
                console.error('Error checking system status:', error);
            });
    });
</script>

<style>
.alert-success {
    background: #1b5e20;
    color: #c8e6c9;
    border-left-color: #4CAF50;
}

.alert-error {
    background: #b71c1c;
    color: #ffcdd2;
    border-left-color: #f44336;
}
</style>
{% endblock %}
